name: DataRepo Alpha Integration Tests
on:
  # Jenkins will kick this job off manually after Alpha is deployed
  workflow_dispatch: {}
jobs:
  alpha-integration-test:
    runs-on: ubuntu-latest
    steps:
    - name: "Checkout code"
      uses: actions/checkout@v2
    - name: "Import Vault secrets"
      id: vault
      uses: hashicorp/vault-action@c8b383ee
      with:
        url: ${{ secrets.VAULT_ADDR }}
        method: approle
        roleId: ${{ secrets.ALPHA_ROLE_ID }}
        secretId: ${{ secrets.ALPHA_SECRET_ID }}
        secrets: |
          secret/dsde/datarepo/alpha/datarepo-api-sa key | B64_APPLICATION_CREDENTIALS ;
    - name: "Write Vault tokens"
      run: |
        base64 --decode <<< ${{ steps.vault.outputs.B64_APPLICATION_CREDENTIALS }} > ${GOOGLE_APPLICATION_CREDENTIALS}
        jq -r .private_key ${GOOGLE_APPLICATION_CREDENTIALS} > ${GOOGLE_SA_CERT}

        echo "::set-env name=GOOGLE_APPLICATION_CREDENTIALS::${GOOGLE_APPLICATION_CREDENTIALS}"
        echo "::set-env name=GOOGLE_SA_CERT::${GOOGLE_SA_CERT}"
      env:
        GOOGLE_APPLICATION_CREDENTIALS: /tmp/jade-account.json
        GOOGLE_SA_CERT: /tmp/jade-account.pem
    - name: "Build and run alpha integration tests"
      run: |
        ./gradlew assemble
        ./gradlew check --scan
#        ./gradlew testIntegration --scan
    - name: "Notify Slack"
      uses: broadinstitute/action-slack@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      with:
        status: ${{ job.status }}
        channel: "#dsde-qa"
        username: "Data Repo tests"
        text: "Alpha integration tests"
#      if: always()
