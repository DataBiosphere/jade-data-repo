name: Unit, Smoke, Connected and Integration tests
on:
  workflow_dispatch: {}
  pull_request:
  schedule:
    - cron: '0 4 * * *' # run at 4 AM UTC, 12PM EST.
# do not allow concurrent runs of this workflow on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
jobs:
  test_unit:
    name: Unit tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      - name: Run unit tests
        env:
          GOOGLE_APPLICATION_CREDENTIALS: 'jade-dev-account.json'
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          TDR_LOG_APPENDER: 'Console-Standard'
        run: |
          # extract service account credentials
          base64 --decode <<< ${{ secrets.SA_B64_CREDENTIALS }} > ${GOOGLE_APPLICATION_CREDENTIALS}
          # assemble code, run unit tests, and generate scan
          ./gradlew assemble
          ./gradlew check --scan jacocoTestReport sonar
  test_connected:
    name: Connected tests
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      - name: Run connected tests
        env:
          # required for azure tests
          AZURE_CREDENTIALS_APPLICATIONID: 0e29ec36-04e8-44d5-ae7c-50dc15135571
          AZURE_CREDENTIALS_HOMETENANTID: fad90753-2022-4456-9b0a-c7e5b934e408
          AZURE_CREDENTIALS_SECRET: ${{ secrets.AZURE_CREDENTIALS_SECRET }}
          # required for synapse tests
          AZURE_SYNAPSE_SQLADMINPASSWORD: ${{ secrets.AZURE_SYNAPSE_SQLADMINPASSWORD }}
          AZURE_SYNAPSE_SQLADMINUSER: ${{ secrets.AZURE_SYNAPSE_SQLADMINUSER }}
          AZURE_SYNAPSE_WORKSPACENAME: tdr-snps-int-east-us-ondemand.sql.azuresynapse.net
          # required for connected tests
          GOOGLE_APPLICATION_CREDENTIALS: jade-dev-account.json
          # required data project for snapshotTest
          GOOGLE_CLOUD_DATA_PROJECT: broad-jade-integration-data
          # required for testAzureBillingProfile
          # uses an azure marketplace app with this hardcoded deployment email
          JADE_USER_EMAIL: connected-tdr-user@notarealemail.org
          # required for rbs tests
          RBS_CLIENT_CREDENTIAL_FILE_PATH: rbs-tools-sa.json
          # output plain logs instead of json
          TDR_LOG_APPENDER: 'Console-Standard'
        run: |
          # extract service account credentials
          base64 --decode <<< ${{ secrets.SA_B64_CREDENTIALS }} > ${GOOGLE_APPLICATION_CREDENTIALS}
          base64 --decode <<< ${{ secrets.B64_RBS_APPLICATION_CREDENTIALS }} > ${RBS_CLIENT_CREDENTIAL_FILE_PATH}
          # assemble code and run connected tests
          ./gradlew assemble
          ./gradlew testConnected --scan
  test_integration:
    name: Integration tests
    runs-on: ubuntu-latest
    timeout-minutes: 300
    services:
      postgres:
        image: postgres:11
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
