name: Alpha Nightly Promotion
on:
  workflow_dispatch: {}
  #Note: We're scheduling this to run before the Jenkins alpha deploy job
  # this schedule is defined here: /dsp-jenkins/src/main/groovy/org/broadinstitute/dspjenkins/FCLegacyDeploy.groovyL130
  # However, github action runs can be delayed over an hour, so leaving extra buffer
  schedule:
    - cron: '0 17 * * 5' # Fridays at 12PM EST or 1PM EDT; 5PM UTC
    - cron: '0 1 * * 1-5' # Sun - Thurs 8PM EST or 9PM EDT; 1AM UTC
env:
  chartVersion: 0.1.677
jobs:
  alpha_promotion:
    permissions:
      contents: 'read'
      id-token: 'write'
      # broadinstitute/action-slack uses the GitHub token to contact the
      # actions API to generate a link to this job.
      actions: 'read'
    strategy:
      matrix:
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: 'Get Previous tag'
        id: apiprevioustag
        run: |
          TAG=$(git for-each-ref --sort=-creatordate --count 1 --format="%(refname:short)" "refs/tags/")
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
      - name: 'Generate IAP token to talk to Sherlock'
        id: 'auth-iap'
        uses: google-github-actions/auth@v0
        with:
          token_format: 'id_token'
          id_token_audience: '1038484894585-k8qvf7l876733laev0lm8kenfa2lj6bn.apps.googleusercontent.com'
          workload_identity_provider: 'projects/1038484894585/locations/global/workloadIdentityPools/github-wi-pool/providers/github-wi-provider'
          service_account: 'dsp-tools-iap-access@dsp-tools-k8s.iam.gserviceaccount.com'
          id_token_include_email: true
      # These Sherlock calls are all separate so they can fail without affecting the others
      - name: 'Update Sherlock'
        run: |
          curl -X 'POST' \
            'https://sherlock-dev.dsp-devops.broadinstitute.org/api/v2/procedures/changesets/plan-and-apply' \
            -H 'accept: application/json' \
            -H 'Content-Type: application/json' \
            -H 'Authorization: Bearer ${{ steps.auth-iap.outputs.id_token }}' \
            -d "{
              \"chartReleases\": [
                {
                  \"chartRelease\": \"alpha/datarepo\",
                  \"toAppVersionExact\": \"${{ steps.apiprevioustag.outputs.tag }}\",
                  \"toAppVersionResolver\": \"exact\",
                  \"toChartVersionExact\": \"${{ env.chartVersion }}\",
                  \"toChartVersionResolver\": \"exact\",
                  \"toHelmfileRef\": \"HEAD\"
                }
              ]
            }"
          curl --fail -X 'POST' \
            'https://sherlock.dsp-devops.broadinstitute.org/api/v2/procedures/changesets/plan-and-apply' \
            -H 'accept: application/json' \
            -H 'Content-Type: application/json' \
            -H 'Authorization: Bearer ${{ steps.auth-iap.outputs.id_token }}' \
            -d "{
              \"chartReleases\": [
                {
                  \"chartRelease\": \"alpha/datarepo\",
                  \"toAppVersionExact\": \"${{ steps.apiprevioustag.outputs.tag }}\",
                  \"toAppVersionResolver\": \"exact\",
                  \"toChartVersionExact\": \"${{ env.chartVersion }}\",
                  \"toChartVersionResolver\": \"exact\",
                  \"toHelmfileRef\": \"HEAD\"
                }
              ]
            }"
      - name: "Notify Slack"
        if: always()
        uses: broadinstitute/action-slack@v3.15.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          MATRIX_CONTEXT: ${{ toJson(matrix) }} # required to work with job field
        with:
          status: ${{ job.status }}
          fields: job,repo,message
          channel: "#jade-alerts"
          username: "Data Repo tests"
          text: "Alpha Nightly Promotion"
