name: Track semVer through environments

on:
  schedule:
    - cron: '0 */3 * * *' # run every 3 hours and on push
  workflow_dispatch: {}

jobs:
  get_versions:
    name: Get semVer for environments
    runs-on: ubuntu-latest
    steps:
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@master
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_BUCKET_SA_KEY }}
          export_default_credentials: true
      - name: Use gcloud copy endpoints.json
        run: gsutil cp gs://deployment-tracking/endpoints.json .
      - shell: bash
        run: |
          endPoints+=( "https://jade.datarepo-dev.broadinstitute.org/configuration" \
            "https://data.alpha.envs-terra.bio/configuration" \
            "https://data.staging.envs-terra.bio/configuration" \
            "https://data.terra.bio/configuration")

          for i in ${endPoints[@]}; do
            if [[ "$i" == *"dev"* ]]
            then
             env=dev
            elif [[ "$i" == *"alpha"* ]]
            then
             env=alpha
            elif [[ "$i" == *"staging"* ]]
            then
             env=staging
            elif [[ "$i" == *"data.terra.bio"* ]]
            then
             env=production
            else
             echo "No env found"
            fi
            date=$(date +%Y-%m-%d\ %H:%M:%S)
            semVer=$(curl -s $i | jq -r '.semVer')
            cat <<< $(jq --arg env "$env" \
              --arg date "$date" \
              --arg semVer "$semVer" \
              '.data += [{"env": "'"$env"'", "date": "'"$date"'", "semVer": "'"$semVer"'"}]' endpoints.json) \
              > endpoints.json
          done
      - name: Use gcloud copy to upload new endpoints.json to bucket
        run: gsutil cp endpoints.json gs://deployment-tracking/endpoints.json
      - name: Print uploaded file
        run: cat endpoints.json
