name: Update Perf Env and Run Nightly Test Runner Tests
env:
  GOOGLE_APPLICATION_CREDENTIALS: /tmp/jade-dev-account.json
  GOOGLE_SA_CERT: /tmp/jade-dev-account.pem
  GOOGLE_CLOUD_PROJECT: broad-jade-perf
  GOOGLE_CLOUD_DATA_PROJECT: broad-jade-perf-data2
  TEST_RUNNER_SERVER_SPECIFICATION_FILE: perf.json
  GOOGLE_ZONE: us-central1
  K8_CLUSTER: jade-master-us-central1
on:
  workflow_dispatch: {}
  #schedule:
  #  - cron: '0 4 * * *' # run at 4 AM UTC, 12PM EST.
jobs:
  test-runner-perf:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout jade-data-repo develop branch"
        uses: actions/checkout@v2
        with:
          ref: develop
      - name: "Import Vault dev secrets"
        uses: hashicorp/vault-action@v2.0.1
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.ROLE_ID }}
          secretId: ${{ secrets.SECRET_ID }}
          secrets: |
            secret/dsde/datarepo/dev/sa-key-b64 sa | B64_APPLICATION_CREDENTIALS ;
      - name: "Configure credentials"
        run: |
          # write vault tokens
          base64 --decode <<< ${B64_APPLICATION_CREDENTIALS} > ${GOOGLE_APPLICATION_CREDENTIALS}
          jq -r .private_key ${GOOGLE_APPLICATION_CREDENTIALS} > ${GOOGLE_SA_CERT}

          gcloud auth activate-service-account --key-file ${GOOGLE_APPLICATION_CREDENTIALS}

          # configure integration prerequisites
          gcloud config set compute/zone ${GOOGLE_ZONE} --quiet
          gcloud config set project ${GOOGLE_CLOUD_PROJECT} --quiet
          gcloud auth configure-docker --quiet
          #echo 'Set google sdk to SA user'
          if [[ -n "${K8_CLUSTER}" ]]; then
            gcloud container clusters get-credentials ${K8_CLUSTER} --zone ${GOOGLE_ZONE}
          fi
      - name: "Whitelist Runner IP"
        run: |
          CUR_IPS=$(gcloud container clusters describe ${K8_CLUSTER} --format json | \
            jq -r '[.masterAuthorizedNetworksConfig.cidrBlocks[] | .cidrBlock]')
            RUNNER_IP=$(curl 'https://api.ipify.org/?format=text' | xargs printf '[ "%s/32" ]')
            NEW_IPS=$(printf '%s\n' $CUR_IPS $RUNNER_IP | jq -s -r 'add | unique | join(",")')
          for i in {1..5}; do
            if gcloud container clusters update ${K8_CLUSTER} \
              --enable-master-authorized-networks \
              --master-authorized-networks ${NEW_IPS}; then
              echo "Successful whitelist"
              break
            else
              echo "Failed to whitelist - Retrying"
              sleep 15
              if [ i == 5 ]; then
                echo "Failed to whitelist - Terminating"
                exit 1
              fi
            fi
          done
      - name: "Assemble data-repo code to generate version.properties file"
        run: ./gradlew clean assemble
      - name: "Read latest jade-data-repo gitHash from version.properties file"
        id: read_property
        run: |
          VERSIONPROPERTIESPATH=./src/main/resources/version.properties
          VERSIONPROPERTY=gitHash
          VERSIONRESULT=$(sed -n "/^[[:space:]]*$VERSIONPROPERTY[[:space:]]*=[[:space:]]*/s/^[[:space:]]*$VERSIONPROPERTY[[:space:]]*=[[:space:]]*//p" "$VERSIONPROPERTIESPATH")
          echo "property value: $VERSIONRESULT"
          echo ::set-output name=value::"$VERSIONRESULT"
      - name: 'Checkout datarepo-helm-definitions repo'
        uses: actions/checkout@v2
        with:
          repository: 'broadinstitute/datarepo-helm-definitions'
          token: ${{ secrets.HELM_REPO_TOKEN }}
          path: datarepo-helm-definitions
      - name: "Update perf image tag with gitHash"
        uses: docker://mikefarah/yq:latest
        with:
          args: yq w -i datarepo-helm-definitions/perf/datarepo-api.yaml image.tag ${{ steps.read_property.outputs.value }}
      - name: "Create datarepo-helm-definition pull request with updated perf image tag"
        uses: broadinstitute/create-pull-request@v3 # forked from peter-evans/create-pull-request
        id: perfTagPR
        with:
          token: ${{ secrets.HELM_REPO_TOKEN }}
          path: datarepo-helm-definitions
          commit-message: "Perf Datarepo version update: ${{ steps.read_property.outputs.value }}"
          committer: datarepo-bot <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          title: "Perf Datarepo version update: ${{ steps.read_property.outputs.value }}"
          branch: "version-update-${{ steps.read_property.outputs.value }}"
          body: |
            Update versions in perf env to reflect image tag ${{ steps.apiprevioustag.outputs.tag }}.
            *Note: This PR was opened by the [update-env GitHub Actions workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).*
          labels: "broadbot,datarepo,automerge"
      - name: "Merge datarepo-helm-definition pull request"
        run: |
          cd ${GITHUB_WORKSPACE}/${workingDir}/datarepo-helm-definitions
          git checkout master
          git config pull.rebase false
          if git rev-parse --verify origin/version-update-${{ steps.read_property.outputs.value }}; then
            git merge origin/version-update-${{ steps.read_property.outputs.value }}
            git branch -d version-update-${{ steps.read_property.outputs.value }}
            git push
          else
            echo "Branch version-update-${{ steps.read_property.outputs.value }} not found."
          fi
          cd ${GITHUB_WORKSPACE}/${workingDir}
      - name: "Run helmfile apply to update perf to use new image tag"
        run: |
          helmfile_version=0.130.0
          os=linux
          arch=amd64   
          wget -q https://github.com/roboll/helmfile/releases/download/v${helmfile_version}/helmfile_${os}_${arch} -O - | tar -xzO ${os}-${arch}/helmfile > /usr/local/bin/helmfile \
            && chmod +x /usr/local/bin/helmfile && \
            rm -rf helmfile-${helmfile_version}-${os}-${arch}.tar.gz
          helmfile --version
          cd ${GITHUB_WORKSPACE}/${workingDir}/datarepo-helm-definitions/perf
          helmfile apply
          cd ${GITHUB_WORKSPACE}/${workingDir}
      - name: "Build and run Test Runner"
        run: |
          cd ${GITHUB_WORKSPACE}/${workingDir}
          echo "Building Data Repo client library"
          ENABLE_SUBPROJECT_TASKS=1 ./gradlew :datarepo-client:clean :datarepo-client:assemble
          cd ${GITHUB_WORKSPACE}/${workingDir}/datarepo-clienttests
          export ORG_GRADLE_PROJECT_datarepoclientjar=$(find .. -type f -name "datarepo-client*.jar")
          echo "ORG_GRADLE_PROJECT_datarepoclientjar = ${ORG_GRADLE_PROJECT_datarepoclientjar}"

          echo "Running test suite"
          ./gradlew runTest --args="suites/NightlyPerfWorkflow.json tmp/TestRunnerResults"

          echo "Collecting measurements"
          ./gradlew collectMeasurements --args="NightlyPerfWorkflow.json tmp/TestRunnerResults"

          echo "Uploading results"
          ./gradlew uploadResults --args="BroadJadeDev.json tmp/TestRunnerResults"

          cd ${GITHUB_WORKSPACE}/${workingDir}
      - name: "Clean whitelisted Runner IP"
        if: always()
        run: |
          # export the original IP list so it can be restored during cleanup
          CUR_IPS=$(gcloud container clusters describe ${K8_CLUSTER} --format json | \
            jq -r '[ .masterAuthorizedNetworksConfig.cidrBlocks[] | .cidrBlock ]')
          RUNNER_IP=$(curl 'https://api.ipify.org/?format=text' | xargs printf '[ "%s/32" ]')
          RUNNER_IP=$(echo ${RUNNER_IP}| jq -r '.[0]')
          RESTORE_IPS=$(printf '%s\n' $CUR_IPS | jq -r --arg RUNNER_IP "$RUNNER_IP" '. - [ $RUNNER_IP ] | unique | join(",")')
          # restore the original list of authorized IPs if they exist
          gcloud container clusters update ${K8_CLUSTER} \
            --enable-master-authorized-networks \
            --master-authorized-networks ${RESTORE_IPS}
