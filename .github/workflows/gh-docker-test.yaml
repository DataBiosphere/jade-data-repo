name: GitHub Docker Test
env:
  GOOGLE_APPLICATION_CREDENTIALS: /tmp/jade-dev-account.json
  GOOGLE_CLOUD_PROJECT: broad-jade-integration
  GOOGLE_REGION: us-central1
  K8_CLUSTER: integration-master
on:
  workflow_dispatch: {}
  pull_request:
    branches:
      - fb-dr-1528-gh-docker
jobs:
  gh_docker_test:
    timeout-minutes: 180
    strategy:
      matrix:
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
      - name: Import Vault Secrets for Development GCR
        uses: hashicorp/vault-action@v2.1.2
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.ROLE_ID }}
          secretId: ${{ secrets.SECRET_ID }}
          secrets: |
            secret/dsde/datarepo/dev/sa-key-b64 sa | B64_APPLICATION_CREDENTIALS ;
      - name: Decode Vault token
        run: |
          base64 --decode <<< ${B64_APPLICATION_CREDENTIALS} > ${GOOGLE_APPLICATION_CREDENTIALS}
      - name: Install Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0.2.1
        with:
          project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}
          service_account_key: ${{ env.B64_APPLICATION_CREDENTIALS }}
          export_default_credentials: true
      - name: Configure Google Cloud SDK
        uses: broadinstitute/datarepo-actions/actions/configure-gcloud-sdk@fb-dr-1673-configure-gcloud-sdk
      - name: Add Runner IP to allowlist
        uses: broadinstitute/datarepo-actions/actions/add-runner-ip@fb-dr-1688-add-runner-ip
      - name: Lock namespace for use
        uses: broadinstitute/datarepo-actions/actions/lock-namespace@fb-dr-1679-lock-namespace
        env:
          K8_NAMESPACES: "integration-1,integration-2,integration-3,integration-6"
      - name: Sleep for a bit
        run: |
          sleep 15
          echo "Slept for a bit"
      - name: Unlock namespace for use
        uses: broadinstitute/datarepo-actions/actions/unlock-namespace@fb-dr-1680-unlock-namespace
      - name: Clean IAM policy
        uses: broadinstitute/datarepo-actions/actions/clean-iam-policy@fb-dr-1685-clean-iam-policy
      - name: Remove Runner IP from allowlist
        uses: broadinstitute/datarepo-actions/actions/rm-runner-ip@fb-dr-1689-rm-runner-ip
